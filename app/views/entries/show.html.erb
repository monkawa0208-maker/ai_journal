<% content_for :body_class, 'entries-show' %>

<article class="entry-detail" 
         data-controller="word-selector"
         data-word-selector-entry-id-value="<%= @entry.id %>">
  <header class="entry-detail__header">
    <div class="entry-detail__title-row">
      <h1><%= h @entry.title %></h1>
      <p class="entry-detail__meta"><%= @entry.posted_on.strftime("%Y年%m月%d日") %></p>
    </div>
  <!-- 既に登録済みの単語を表示 -->
    <div class="entry-vocabularies">
      <p class="selection-hint">💡 英単語を選択してMyDictionaryに登録できます。</p>
      <h3>この日記で登録した単語:</h3>
      <div class="vocabulary-tags">
        <% if @entry.vocabularies.any? %>
          <% @entry.vocabularies.each do |vocab| %>
            <%= link_to "#{vocab.word} ： #{vocab.meaning}", edit_vocabulary_path(vocab), class: "vocabulary-tag" %>
          <% end %>
        <% else %>
          <p>まだ単語が登録されていません。</p>
        <% end %>
      </div>
    </div>
  </header>

  <section class="entry-detail__section">
    <div class="section-header-with-hint">
      <h2>本文（英語）</h2>
    </div>
    <div class="entry-detail__body word-selectable">
      <%= simple_format(h(@entry.content)) %>
    </div>
  </section>

  <section class="entry-detail__section ai-feedback" data-controller="ai-feedback">
    <h2>AIフィードバック</h2>
    <% if @entry.response.present? %>
      <div class="ai-feedback-content" data-ai-feedback-target="output">
        <%= raw @entry.response
          .gsub(/# 英文アドバイス/, '<strong class="feedback-section-title">✏️ 英文アドバイス</strong>')
          .gsub(/# 修正後の文章/, '<strong class="feedback-section-title">✨ 修正後の文章</strong>')
          .gsub(/# より良い表現/, '<strong class="feedback-section-title">🌟 より良い表現</strong>')
          .gsub(/# コメント/, '<strong class="feedback-section-title">💬 コメント</strong>')
          .gsub(/\n/, '<br>') %>
      </div>
    <% else %>
      <p class="ai-feedback__hint" data-ai-feedback-target="hint">まだコメントはありません。ボタンを押すとAIがコメントします。</p>
      <div data-ai-feedback-target="output"></div>
      <button class="button primary"
              data-ai-feedback-target="button"
              data-action="click->ai-feedback#generate"
              data-url="<%= generate_feedback_entry_path(@entry, format: :json) %>">AIからフィードバックをもらう</button>
    <% end %>
  </section>

  <% if @entry.content_ja.present? %>
    <section class="entry-detail__section japanese-section">
      <h2>日本語原文</h2>
      <div class="entry-detail__body">
        <%= simple_format(h(@entry.content_ja)) %>
      </div>
    </section>
  <% end %>

  <% if @entry.ai_translate.present? %>
    <section class="entry-detail__section ai-translation-section">
      <h2>AI翻訳結果</h2>
      <div class="ai-translation-content">
        <%= raw @entry.ai_translate
          .gsub(/# 翻訳後の文章/, '<strong class="translation-section-title">📝 翻訳後の文章</strong>')
          .gsub(/# Key Points/, '<strong class="translation-section-title">💡 Key Points</strong>')
          .gsub(/# Vocabulary/, '<strong class="translation-section-title">📚 Vocabulary</strong>')
          .gsub(/\n/, '<br>') %>
      </div>
    </section>
  <% end %>

  <% if @entry.image.attached? %>
    <% begin %>
      <section class="entry-detail__section">
        <h2>Photo of the day</h2>
        <% if @entry.image.variable? %>
          <%= image_tag @entry.image.variant(resize_to_limit: [800, 800]),
                        alt: "#{@entry.title.presence || '日記'}の画像" %>
        <% else %>
          <%= image_tag @entry.image,
                        alt: "#{@entry.title.presence || '日記'}の画像" %>
        <% end %>
      </section>
    <% rescue ActiveStorage::FileNotFoundError, ActiveStorage::IntegrityError => e %>
      <%# 画像ファイルが見つからない場合は表示しない %>
      <% Rails.logger.warn "画像の読み込みに失敗しました (Entry ##{@entry.id}): #{e.message}" %>
    <% end %>
  <% end %>

  <nav class="entry-detail__actions">
    <%= link_to "編集", edit_entry_path(@entry), class: "button secondary" %>
    <%= link_to "削除", entry_path(@entry), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, class: "button danger" %>
    <%= link_to "一覧へ戻る", entries_path, class: "button ghost" %>
  </nav>

  <!-- 単語登録モーダル -->
  <div class="modal" data-word-selector-target="modal">
  <div class="modal-content">
    <span class="modal-close" data-action="click->word-selector#closeModal">&times;</span>
    <h2>単語を登録</h2>
    
    <form data-word-selector-target="form" data-action="submit->word-selector#submitWord">
      <div class="form-group">
        <label>英単語</label>
        <input type="text" 
               data-word-selector-target="wordInput" 
               class="form-control"
               placeholder="例: grateful"
               required>
      </div>
      <div class="form-group">
        <label>日本語の意味</label>
        <textarea data-word-selector-target="meaningInput" 
                  class="form-control" 
                  rows="3" 
                  placeholder="単語の意味を入力してください..."
                  required></textarea>
      </div>
      <div class="form-actions">
        <button type="button" 
                class="button secondary" 
                data-action="click->word-selector#closeModal">
          キャンセル
        </button>
        <button type="submit" 
                class="button primary"
                data-word-selector-target="submitButton">
          登録
        </button>
      </div>
    </form>
  </div>
  </div>
</article>
