# MyDictionary機能 要件定義書

## 1. 機能概要

日記で使用した英単語を忘れないように記録し、フラッシュカード形式で復習できる単語帳機能（MyDictionary）を実装する。

## 2. 目的

- ユーザーが日記作成時に使用した英単語を記録・管理できるようにする
- 記録した単語を効率的に復習できる仕組みを提供する
- 学習進捗を可視化し、英語学習のモチベーション向上を図る

## 3. 機能要件

### 3.1 英単語の登録

#### 3.1.1 登録方法
**方法1: 日記ページから登録**
- 日記詳細ページ（show）または編集ページ（edit）で英語本文の単語を選択して登録
- テキスト選択するとモーダルウィンドウが自動表示される
- 選択した単語が自動入力される（単語も編集可能）
- ユーザーが日本語の意味を手動入力する
- 「登録」ボタンでMyDictionaryに追加
- モーダルが自動的に閉じ、画面右上に成功通知が表示される
- 一つの日記から複数の単語を登録可能（単語ごとにモーダルが開閉）

**方法2: 単語一覧ページから登録**
- 単語一覧ページの「➕ 新しい単語を追加」ボタンから登録
- 日記に紐づかない単語として登録可能
- 後から編集画面で単語や意味を修正可能

#### 3.1.2 保存する情報
各単語エントリには以下の情報を保存する：
- **英単語**（word）：登録対象の英単語（必須）
- **日本語の意味**（meaning）：ユーザーが入力した日本語訳・意味（必須）
- **使用した日記へのリンク**：その単語を使用した日記への参照（任意・複数可）
- **習得済みフラグ**（mastered）：単語を習得済みとしてマークできる（デフォルト: false）
- **お気に入りフラグ**（favorited）：重要な単語にお気に入りマークをつけられる（デフォルト: false）
- **ユーザーID**：単語の所有者（必須）

**注意点**：
- 単語は日記に紐づかなくても登録可能（独立した単語帳エントリとして）
- 一つの単語を複数の日記に関連付け可能
- 日記から登録した場合は自動的にその日記と関連付けられる

#### 3.1.3 重複単語の扱い
- 同じ単語を複数の日記で使用した場合、1つの単語エントリに複数の日記リンクを関連付ける
- データベース設計：多対多の関係（Entry ⇔ EntryVocabulary ⇔ Vocabulary）
- 単語はユーザーごとに一意（user_id + word でユニーク制約）

#### 3.1.4 既存単語の再登録
- 既に登録済みの単語を再度登録しようとした場合：
  - モーダルのタイトルが「単語を編集」に変わる
  - 既存の意味が自動的に入力される
  - ユーザーが意味を修正できる
  - 「登録」ボタンで意味を更新
  - 成功通知は「✅ 「単語」を更新しました」と表示

### 3.2 単語一覧ページ

#### 3.2.1 表示場所
- ヘッダーに「MyDictionary」リンクを追加
- NEW POSTボタンの近くに配置

#### 3.2.2 表示内容
ページ上部：
- 「新しい単語を追加」ボタン（日記に紐づかない単語を追加）

各単語カードには以下を表示：
- 英単語
- 日本語の意味
- 習得済みマーク（アイコン/バッジ）
- お気に入りマーク（アイコン/バッジ）
- 使用した日記へのリンク一覧（日付とタイトル）※日記に紐づいている場合のみ
- 編集ボタン
- 削除ボタン

#### 3.2.3 検索機能
- 単語名で検索できる検索バーを実装
- リアルタイム検索（入力に応じて絞り込み）

#### 3.2.4 フィルタリング機能
以下のフィルターボタンを提供：
- **全て**：全ての単語を表示（デフォルト）
- **未習得**：習得済みフラグがfalseの単語のみ
- **習得済み**：習得済みフラグがtrueの単語のみ
- **お気に入り**：お気に入りフラグがtrueの単語のみ

#### 3.2.5 習得済み単語の表示
- 習得済みマークをつけた単語も一覧に表示し続ける
- フィルターで表示/非表示を切り替え可能

### 3.3 単語の管理機能

#### 3.3.1 追加
**パターンA: 日記ページから追加**
- 日記詳細ページまたは編集ページで単語を選択して追加
- Ajax通信で非同期に登録
- 登録後はモーダルが自動的に閉じる
- 画面右上に成功通知（トースト）が表示される
- 登録済み単語がヘッダー内にタグとして即座に表示される
- 一つの日記から複数の単語を登録可能（単語ごとに選択→登録を繰り返す）

**パターンB: 単語一覧ページから追加**
- 「➕ 新しい単語を追加」ボタンから新規作成ページへ遷移
- 日記に紐づかない単語として登録
- 単語と意味の両方を編集可能

#### 3.3.2 編集
- 単語一覧ページの編集ボタンから編集画面へ遷移
- 編集可能項目：
  - 英単語（テキストフィールド）
  - 日本語の意味（テキストエリア）
  - お気に入りフラグ（チェックボックス）
  - 習得済みフラグ（チェックボックス）
- 全てのフィールドが編集可能
- 既存の単語と重複する場合はバリデーションエラー

#### 3.3.3 削除
- 単語一覧ページの削除ボタンから削除
- 確認ダイアログを表示
- 削除すると関連する日記とのリンクも削除される

### 3.4 フラッシュカード復習機能

#### 3.4.1 アクセス方法
- 単語一覧ページに「フラッシュカード復習」ボタンを配置
- ボタンクリックでフラッシュカードページへ遷移

#### 3.4.2 復習モード
以下の2つのモードを実装し、ユーザーが選択可能：
- **英→日モード**：英単語を表示し、日本語の意味を思い出す
- **日→英モード**：日本語の意味を表示し、英単語を思い出す

#### 3.4.3 カード操作
- カードをクリックまたはタップでフリップ（裏返し）
- 表面：問題（英単語 or 日本語）
- 裏面：答え（日本語 or 英単語）
- 「前の単語へ」「次の単語へ」ボタンで単語を移動
- 現在の位置表示（例: 3 / 20）
- キーボード操作対応
  - ← : 前の単語へ
  - → : 次の単語へ
  - Space/Enter : カードをフリップ

#### 3.4.4 学習状態の更新
- フラッシュカードページから習得済みマークを切り替え可能
- フラッシュカードページからお気に入りマークを切り替え可能
- 習得済みまたはお気に入りにした単語も引き続き復習対象に含める
- 状態変更は即座にデータベースに反映（Ajax）

### 3.5 対象単語の範囲
- ユーザーが登録した全ての単語を対象
- フィルタリングで未習得のみに絞り込み可能

## 4. 非機能要件

### 4.1 パフォーマンス
- 単語一覧ページは100件以上の単語でも快適に動作すること
- 検索・フィルタリングはクライアントサイドで高速に処理

### 4.2 レスポンシブデザイン
- スマートフォン、タブレット、PCで適切に表示
- フラッシュカードはタッチ操作に対応

### 4.3 ユーザビリティ
- 単語登録は2クリック以内で完了（選択→登録）
- モーダル登録後は自動的に閉じ、トースト通知で成功を通知
- 既存単語を選択すると編集モードになり、意味が自動入力される
- フラッシュカードは直感的に操作できる（クリック、キーボード対応）
- 習得済み/お気に入りの切り替えは即座に反映
- 日記のヘッダーがスティッキー表示され、登録済み単語が常に見える

## 5. データベース設計

### 5.1 vocabulariesテーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | integer | PK | 主キー |
| word | string | NOT NULL | 英単語 |
| meaning | text | NOT NULL | 日本語の意味 |
| mastered | boolean | DEFAULT false | 習得済みフラグ |
| favorited | boolean | DEFAULT false | お気に入りフラグ |
| user_id | integer | FK, NOT NULL | ユーザーID |
| created_at | datetime | | 作成日時 |
| updated_at | datetime | | 更新日時 |

**インデックス**:
- user_id
- [user_id, word] (unique)

### 5.2 entry_vocabulariesテーブル（中間テーブル）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | integer | PK | 主キー |
| entry_id | integer | FK, NOT NULL | 日記ID |
| vocabulary_id | integer | FK, NOT NULL | 単語ID |
| created_at | datetime | | 作成日時 |
| updated_at | datetime | | 更新日時 |

**インデックス**:
- entry_id
- vocabulary_id
- [entry_id, vocabulary_id] (unique)

**注意点**:
- このテーブルは日記と単語の関連付けを管理するため、単語が日記に紐づいている場合のみレコードが存在する
- 単語は entry_vocabularies にレコードがなくても存在可能（独立した単語）
- 一つの単語（vocabulary）は複数の日記（entry）と関連付け可能
- 一つの日記（entry）は複数の単語（vocabulary）と関連付け可能

## 6. UI/UX設計

### 6.1 ヘッダー
- 「MyDictionary」リンクを「NEW POST」ボタンの隣に配置
- ログインユーザーのみ表示

### 6.2 単語カードデザイン
- カード形式で視覚的に見やすく
- 習得済み/お気に入りはアイコンで表現
- ホバー時にアクションボタンを表示

### 6.3 フラッシュカードデザイン
- カードフリップアニメーション（3D回転効果）
- 大きなフォントで読みやすく
- モード切り替えは目立つ位置に配置

### 6.4 カラースキーム
- 既存のAI Journalデザインと統一
- 習得済み: グリーン系
- お気に入り: イエロー/ゴールド系

## 7. 実装の優先順位

### Phase 1（最優先）
1. データベース・モデル設計
2. 単語登録機能（日記ページからのクリック登録）
3. 単語一覧ページ（基本表示）

### Phase 2
4. 編集・削除機能
5. 検索・フィルタリング機能
6. 習得済み/お気に入り機能

### Phase 3
7. フラッシュカード復習機能
8. UI/UXの洗練
9. テスト追加

## 8. 制約事項

- 英単語のバリデーションは実装しない（特殊記号や数字も許可）
- 発音機能は実装しない（将来的な拡張候補）
- 単語の自動抽出・提案機能は実装しない
- オフライン機能は実装しない

## 9. 将来的な拡張候補

- AIによる単語の自動抽出・提案
- スペルチェック機能
- 音声読み上げ機能
- 学習統計・グラフ表示
- 定期的な復習リマインダー
- エクスポート機能（CSV, PDF）
- 単語帳の共有機能

