# App Directory リファクタリングタスク

## 概要
appディレクトリ全体のコードを分析し、改善すべき点を整理しました。以下のタスクを優先度順に実装していきます。

## 優先度：高（必須）

### 1. コントローラーの共通化とDRY原則の適用

#### 1.1 EntriesController の冗長性解消
- **問題**: `translate`, `preview_feedback`, `generate_feedback` メソッドでエラーハンドリングが重複
- **解決策**: 
  - 共通のエラーハンドリングメソッドを作成
  - AIサービス呼び出しの共通化
  - レスポンス形式の統一

#### 1.2 VocabulariesController の改善
- **問題**: `add_from_entry` メソッドが長すぎる（47行）
- **解決策**:
  - 単語作成/更新ロジックをサービスオブジェクトに分離
  - バリデーション処理の共通化
  - エラーハンドリングの統一

#### 1.3 ApplicationController の拡張
- **問題**: 認証・認可の共通処理が不足
- **解決策**:
  - 共通の認証メソッド追加
  - 権限チェックのヘルパーメソッド作成
  - フラッシュメッセージの共通化

### 2. モデルの改善

#### 2.1 Entry モデルのバリデーション強化
- **問題**: バリデーションが基本的なもののみ
- **解決策**:
  - コンテンツの品質チェック（文字数、内容の妥当性）
  - 画像ファイルのバリデーション強化
  - カスタムバリデーターの追加

#### 2.2 Vocabulary モデルの機能拡張
- **問題**: 基本的なCRUDのみ
- **解決策**:
  - 学習進捗の追跡機能
  - 単語の難易度レベル追加
  - 関連するエントリーの統計情報

#### 2.3 User モデルの拡張
- **問題**: 基本的なDevise設定のみ
- **解決策**:
  - プロフィール情報の追加
  - 学習統計の追跡
  - アバター画像のサポート

### 3. サービスクラスの改善

#### 3.1 AiFeedbackGenerator の改善
- **問題**: プロンプトが長すぎて保守性が低い
- **解決策**:
  - プロンプトテンプレートの外部化
  - 設定可能なパラメータ（温度、最大トークン数）
  - エラーハンドリングの強化

#### 3.2 AiTranslator の改善
- **問題**: システムプロンプトが長すぎる
- **解決策**:
  - プロンプトテンプレートの外部化
  - 翻訳品質の評価機能
  - キャッシュ機能の追加

#### 3.3 新しいサービスクラスの追加
- **VocabularyService**: 単語管理のビジネスロジック
- **EntryService**: エントリー管理のビジネスロジック
- **NotificationService**: ユーザー通知の管理

## 優先度：中（推奨）

### 4. ビューの改善

#### 4.1 パーシャルの活用
- **問題**: ビューファイルが長すぎる（特に `_form.html.erb`）
- **解決策**:
  - フォームセクションのパーシャル化
  - 共通UIコンポーネントの作成
  - エラーメッセージ表示の統一

#### 4.2 ヘルパーメソッドの活用
- **問題**: ビューにロジックが混在
- **解決策**:
  - 表示ロジックのヘルパー化
  - 共通のフォーマット関数作成
  - 条件分岐の簡素化

#### 4.3 アクセシビリティの向上
- **問題**: アクセシビリティ属性が不足
- **解決策**:
  - ARIA属性の追加
  - キーボードナビゲーションの改善
  - スクリーンリーダー対応

### 5. CSS/スタイルの改善

#### 5.1 CSS変数の活用
- **問題**: 色やサイズがハードコーディング
- **解決策**:
  - CSS変数の定義と活用
  - テーマシステムの構築
  - ダークモード対応

#### 5.2 レスポンシブデザインの改善
- **問題**: 一部のコンポーネントでレスポンシブ対応が不十分
- **解決策**:
  - モバイルファーストデザインの適用
  - ブレークポイントの統一
  - タッチフレンドリーなUI

#### 5.3 パフォーマンスの最適化
- **問題**: CSSファイルが大きすぎる
- **解決策**:
  - 未使用CSSの削除
  - クリティカルCSSの分離
  - アニメーションの最適化

## 優先度：低（将来的な改善）

### 6. アーキテクチャの改善

#### 6.1 関心の分離
- **問題**: コントローラーにビジネスロジックが混在
- **解決策**:
  - サービスオブジェクトパターンの拡張
  - フォームオブジェクトの導入
  - クエリオブジェクトの活用

#### 6.2 テストの追加
- **問題**: テストカバレッジが不十分
- **解決策**:
  - 単体テストの追加
  - 統合テストの実装
  - システムテストの充実

#### 6.3 パフォーマンスの最適化
- **問題**: N+1クエリの可能性
- **解決策**:
  - 適切なincludesの追加
  - キャッシュ戦略の実装
  - データベースクエリの最適化

### 7. セキュリティの強化

#### 7.1 入力値の検証強化
- **問題**: クライアントサイドの検証のみ
- **解決策**:
  - サーバーサイドの検証強化
  - XSS対策の強化
  - CSRF対策の確認

#### 7.2 認証・認可の強化
- **問題**: 基本的なDevise設定のみ
- **解決策**:
  - 多要素認証の導入
  - セッション管理の改善
  - 権限管理の細分化

## 実装順序

### Phase 1: 基盤の改善（1-2週間）
1. コントローラーの共通化
2. サービスクラスの改善
3. エラーハンドリングの統一

### Phase 2: モデルの強化（1週間）
1. バリデーションの強化（不要）
2. ビジネスロジックの分離
3. 新しいサービスクラスの追加（不要）

### Phase 3: UI/UXの改善（1-2週間）
1. ビューのパーシャル化
2. CSS変数の導入
3. レスポンシブデザインの改善（不要）

### Phase 4: 高度な機能（2-3週間）
1. アーキテクチャの改善
2. テストの充実
3. パフォーマンスの最適化

## 注意事項

- 既存の機能を壊さないよう段階的に実装
- 各フェーズでテストを実行し、動作確認を行う
- ユーザー体験を最優先に考慮
- パフォーマンスへの影響を常に監視

## 成功指標

- コードの重複率の削減（目標：50%以上削減）
- テストカバレッジの向上（目標：80%以上）
- ページ読み込み時間の短縮（目標：20%以上短縮）
- ユーザー満足度の向上
